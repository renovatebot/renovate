name: Check for Undesirable Test Additions

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check_undesirable_code:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Ensure we fetch all history for comparison
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Check for undesirable code
        run: |
          #!/bin/bash
          set -e

          # Fetch the base branch
          git fetch origin ${{ github.event.pull_request.base.ref }}

          BASE_BRANCH=origin/${{ github.event.pull_request.base.ref }}

          # Get the list of changed files with their statuses
          git diff --name-status $BASE_BRANCH..HEAD > diff_name_status.txt

          # Initialize counts for __fixtures__ directories
          NUM_ADDED_FIXTURES=0
          NUM_DELETED_FIXTURES=0

          # Process added files in __fixtures__
          ADDED_FIXTURES=$(grep '^A' diff_name_status.txt | awk '{print $2}' | grep '/__fixtures__/')
          NUM_ADDED_FIXTURES=$(echo "$ADDED_FIXTURES" | grep -c . || true)

          # Process deleted files in __fixtures__
          DELETED_FIXTURES=$(grep '^D' diff_name_status.txt | awk '{print $2}' | grep '/__fixtures__/')
          NUM_DELETED_FIXTURES=$(echo "$DELETED_FIXTURES" | grep -c . || true)

          echo "Number of added files in __fixtures__: $NUM_ADDED_FIXTURES"
          echo "Number of deleted files in __fixtures__: $NUM_DELETED_FIXTURES"

          if [ "$NUM_ADDED_FIXTURES" -gt "$NUM_DELETED_FIXTURES" ]; then
              echo "Error: More files have been added to __fixtures__ directories than deleted."
              exit 1
          fi

          # Check for undesirable code patterns in *.spec.ts files
          git diff $BASE_BRANCH..HEAD -- '*.spec.ts' > diff_spec_ts.txt

          # Count additions and deletions of undesirable code patterns
          ADDED_SNAPSHOTS=$(grep '^+' diff_spec_ts.txt | grep -v '^+++' | grep -E '\.toMatch(Snapshot|InlineSnapshot)\(' | wc -l)
          DELETED_SNAPSHOTS=$(grep '^-' diff_spec_ts.txt | grep -v '^---' | grep -E '\.toMatch(Snapshot|InlineSnapshot)\(' | wc -l)

          echo "Undesirable code patterns added: $ADDED_SNAPSHOTS"
          echo "Undesirable code patterns deleted: $DELETED_SNAPSHOTS"

          if [ "$ADDED_SNAPSHOTS" -gt "$DELETED_SNAPSHOTS" ]; then
              echo "Error: More undesirable code patterns have been added than deleted."
              exit 1
          fi

          echo "Checks passed."
