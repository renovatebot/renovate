name: Publish to npm

on:
  push:
    branches:
      - '**'

permissions:
  contents: read
  packages: write

env:
  NODE_VERSION: 24

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          show-progress: false

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@dominic-r'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Generate version
        id: version
        run: |
          # Use short commit SHA and timestamp for unique version
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          VERSION="0.0.0-${TIMESTAMP}-${SHORT_SHA}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update package.json for publish
        run: |
          # Update package name and version for scoped publish
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.name = '@dominic-r/renovate-branch-local';
            pkg.version = '${{ steps.version.outputs.version }}';
            pkg.repository = {
              type: 'git',
              url: 'https://github.com/${{ github.repository }}.git'
            };
            pkg.publishConfig = {
              registry: 'https://npm.pkg.github.com'
            };
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Publish to GitHub Packages
        run: pnpm publish --no-git-checks --tag dev
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
