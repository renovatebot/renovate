name: Cancel stale merge queue workflows
on:
  merge_group:
    types:
      - destroyed

permissions:
  actions: write
  contents: read

jobs:
  cancel-workflows:
    name: Cancel Workflow Runs

    runs-on: ubuntu-latest

    if: github.event.reason != 'merged'

    steps:
      - name: Get Merge Queue Commit SHA
        id: get-sha
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Head SHA: ${{ github.sha }}"
          echo "Merge Group Reason: ${{ github.event.reason }}"

      - name: Cancel Workflow Runs by SHA
        run: |
          # Get all workflow runs for the specific SHA
          workflow_runs=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?head_sha=${{ github.sha }}")

          # Extract run IDs and cancel them (except current workflow)
          current_run_id="${{ github.run_id }}"
          echo "Current Run ID: $current_run_id"
          echo "$workflow_runs" | jq -r '.workflow_runs[] | select(.status != "completed") | .id' | while read -r run_id; do
            echo "Run ID: $run_id"
            if [ -n "$run_id" ] && [ "$run_id" != "$current_run_id" ]; then
              echo "Cancelling workflow run $run_id"
              curl -X POST -H "Authorization: Bearer ${{ github.token }}" \
                "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id/cancel"
            fi
          done
