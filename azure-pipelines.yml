trigger:
  batch: true
  branches:
    include:
      - '*'
pr:
  autoCancel: true
  branches:
    include:
      - '*'

variables:
  YARN_CACHE_FOLDER: $(Pipeline.Workspace)/.yarn
  CI: true

jobs:
  - job: 'Test'

    # TODO: add build variants
    # https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops
    # linux: ubuntu-16.04
    # mac: macOS-10.13, macOS-10.14
    strategy:
      matrix:
        windows-node10-py3.7:
          imageName: 'vs2017-win2016'
          nodeVersion: '10.x'
          pythonVersion: '3.7'
        windows-node12-py3.7:
          imageName: 'vs2017-win2016'
          nodeVersion: '12.x'
          pythonVersion: '3.7'
        linux-node10-py3.7:
          imageName: 'ubuntu-16.04'
          nodeVersion: '10.x'
          pythonVersion: '3.7'
        macos-node10-py3.7:
          imageName: 'macOS-10.14'
          nodeVersion: '10.x'
          pythonVersion: '3.7'

    pool:
      vmImage: $(imageName)

    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '$(nodeVersion)'
        displayName: 'Install Node.js'

      - task: UsePythonVersion@0
        inputs:
          versionSpec: '$(pythonVersion)'
        displayName: 'Install Python'

      - pwsh: python -m pip install --upgrade pip setuptools wheel
        displayName: 'Install python tools'

      - pwsh: |
          git config --global user.email 'bot@renovateapp.com'
          git config --global user.name  'Renovate Bot'
          git config --global core.autocrlf false
          git config --global core.symlinks true
          node --version
          python --version
          yarn --version
          pip --version
        displayName: 'Init platform'

      - pwsh: |
          yarn install --no-progress --frozen-lockfile
          pip install --user -r requirements.txt
        displayName: 'Installing Dependencies'

      - pwsh: |
          yarn lint
          yarn test-schema
          yarn type-check
        displayName: 'Lint'

      - pwsh: yarn build
        displayName: 'Build'

      - pwsh: yarn jest -i --ci --reporters=default --reporters=jest-junit --coverageReporters=text-summary --coverageReporters=cobertura --no-cache
        displayName: 'Unit Tests'
        continueOnError: true

      - task: PublishTestResults@2
        inputs:
          testResultsFiles: 'junit.xml'
          testRunTitle: 'CI Tests $(Agent.OS)'
        displayName: 'Publish test results'
        condition: succeededOrFailed()

      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/*coverage.xml'
          reportDirectory: '$(System.DefaultWorkingDirectory)/**/coverage'
        displayName: 'Publish coverage results'

      - pwsh: yarn test-e2e
        displayName: 'E2E Tests'
