skip_tags: true
skip_branch_with_pr: true

max_jobs: 2
clone_depth: 5

image: Visual Studio 2017

environment:
  matrix:
    - nodejs_version: 10
      python_version: 37
    - nodejs_version: 12
      python_version: 37

matrix:
  fast_finish: true

cache:
  - node_modules -> yarn.lock
  - '%APPDATA%\npm-cache'
  - '%LOCALAPPDATA%\Yarn'
  - '%LOCALAPPDATA%\pip\Cache -> .appveyor.yml'
  - '%LOCALAPPDATA%\NuGet\Cache -> .appveyor.yml' # choco cache

init:
  - git config --global core.autocrlf false
  - git config --global core.symlinks true
  - git config --global user.email 'bot@renovateapp.com'
  - git config --global user.name  'Renovate Bot'

install:
  - ps: Install-Product node $env:nodejs_version x64
  - node --version
  - cup yarn
  - yarn --version
  - SET PATH=C:\Python%python_version%-x64;%PATH%
  - python --version
  - python -m pip install --upgrade pip
  - pip --version
  - yarn install --frozen-lockfile --link-duplicates
  - pip install --user -r requirements.txt

build_script:
  - yarn lint
  - yarn test-schema
  - yarn type-check
  - yarn build

test_script:
  - yarn jest -i --ci --reporters=default --reporters=jest-junit
  - yarn test-e2e

on_finish:
  - ps: |
      $wc = New-Object 'System.Net.WebClient'
      $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\junit.xml))
